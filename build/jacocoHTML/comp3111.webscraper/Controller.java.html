<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Controller.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">2018F-COMP3111-master</a> &gt; <a href="index.source.html" class="el_package">comp3111.webscraper</a> &gt; <span class="el_source">Controller.java</span></div><h1>Controller.java</h1><pre class="source lang-java linenums">/**
 * 
 */
package comp3111.webscraper;


import javafx.beans.binding.Bindings;
import javafx.beans.binding.BooleanBinding;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.fxml.FXML;
import javafx.scene.control.Label;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.TextField;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.control.TextArea;
import javafx.scene.control.Hyperlink;

import javafx.scene.control.Button;
import javafx.scene.control.Alert;
import javafx.scene.control.MenuItem;


import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;


/**
 * 
 * @author kevinw
 *
 *
 * Controller class that manage GUI interaction. Please see document about JavaFX for details.
 * 
 */

public class Controller extends WebScraperApplication{

	@FXML 
	private Label labelCount; 

	@FXML 
	private Label labelPrice; 

	@FXML 
	private Hyperlink labelMin; 

	@FXML 
	private Hyperlink labelLatest; 

	@FXML
	private TextField textFieldKeyword;

	@FXML
	private TextField textFieldRefineKeyword;

	@FXML
	private TextArea textAreaConsole;

	@FXML
	private TableView&lt;TableItem&gt; table;

	@FXML
	private TableColumn&lt;TableItem,String&gt; itemTitle;

	@FXML
	private TableColumn&lt;TableItem,Double&gt; itemPrice;

	@FXML
	private TableColumn&lt;TableItem,String&gt; itemURL;

	@FXML
	private TableColumn&lt;TableItem,String&gt; itemDate;

	@FXML
	private Button RefineButton;

	@FXML
	private MenuItem lastSearch;


	private WebScraper scraper;

<span class="fc" id="L88">	public static int size = 0;</span>
<span class="fc" id="L89">	public static int pages = 0;</span>
<span class="fc" id="L90">	public static String lastKeyword = &quot;&quot;;</span>
<span class="fc" id="L91">	public static String latestKeyword = &quot;&quot;;</span>

	/**
	 * Default controller
	 */
<span class="fc" id="L96">	 public Controller() {</span>
<span class="fc" id="L97">		 scraper = new WebScraper();</span>
<span class="fc" id="L98">	 }</span>

	 /**
	  * Default initializer.
	  */
	 @FXML
	 private void initialize() {
<span class="nc" id="L105">		 initProgram();</span>
<span class="nc" id="L106">	 }</span>

	 /**
	  * Called when the search button is pressed.
	  * @throws ParseException 
	  */
	 @FXML
	 private void actionSearch() throws ParseException {
<span class="nc" id="L114">		 List &lt;Item&gt; result = search();</span>
<span class="nc" id="L115">		 summary(result);</span>
<span class="nc" id="L116">		 fillTable(result);</span>

<span class="nc" id="L118">	 }</span>
	 @FXML
	 private void actionRefine() throws ParseException {

<span class="nc" id="L122">		 System.out.println(&quot;actionRefine: &quot; + textFieldRefineKeyword.getText());</span>


<span class="nc" id="L125">		 List&lt;Item&gt; refine = scraper.refine(textFieldRefineKeyword.getText());</span>
<span class="nc" id="L126">		 String output = &quot;&quot;;</span>

<span class="nc bnc" id="L128" title="All 2 branches missed.">		 for (Item item : refine) {</span>
<span class="nc" id="L129">			 output += item.getTitle() + &quot;\t&quot; + item.getPortal() + &quot;\t&quot; + item.getPrice() + &quot;\t&quot; +item.getUrl() + &quot;\n&quot;;</span>
<span class="nc" id="L130">		 }</span>
<span class="nc" id="L131">		 RefineButton.setDisable(true);</span>
<span class="nc" id="L132">		 textAreaConsole.setText(output); </span>
<span class="nc" id="L133">		 summary(refine);</span>
<span class="nc" id="L134">		 fillTable(refine);</span>
		 
<span class="nc" id="L136">	 }</span>
	 /**
	  * Called when the new button is pressed. Very dummy action - print something in the command prompt.
	  */
	 @FXML
	 private void actionLast() throws ParseException {
<span class="nc" id="L142">		 System.out.println(&quot;actionLast&quot;);</span>
<span class="nc" id="L143">		 last();</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">		 if (lastKeyword != &quot;&quot;) {</span>
<span class="nc" id="L145">			 actionSearch();</span>
		 }
<span class="nc" id="L147">	 }</span>

	 @FXML
	 private void actionAbout() {
<span class="nc" id="L151">		 System.out.println(&quot;actionAbout&quot;);</span>
<span class="nc" id="L152">		 Alert dg = dialogAbout();</span>
<span class="nc" id="L153">		 dg.show();</span>
<span class="nc" id="L154">	 }</span>

	 @FXML
	 private void actionQuit() {
<span class="nc" id="L158">		 System.out.println(&quot;actionQuit&quot;);</span>
<span class="nc" id="L159">		 quit();</span>
<span class="nc" id="L160">	 }</span>

	 @FXML
	 private void actionClose() {
<span class="nc" id="L164">		 System.out.println(&quot;actionClose&quot;);</span>
<span class="nc" id="L165">		 close();</span>
<span class="nc" id="L166">	 }</span>

	 @FXML
	 private void actionLowest() {
<span class="nc" id="L170">		 getHostServices().showDocument(labelMin.getText());</span>
<span class="nc" id="L171">	 }</span>
	 
	 @FXML
	 private void actionLatest() {
<span class="nc" id="L175">		 getHostServices().showDocument(labelLatest.getText());</span>
<span class="nc" id="L176">	 }</span>
	 
	 private void initProgram() {
<span class="nc" id="L179">		 lastSearch.setDisable(true);</span>
<span class="nc" id="L180">		 RefineButton.setDisable(true);</span>
<span class="nc" id="L181">	 }</span>
	 
	 public List&lt;Item&gt; search() {
<span class="fc" id="L184">		 lastKeyword = latestKeyword;</span>
<span class="nc" id="L185">		 latestKeyword = textFieldKeyword.getText();</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">		 if (lastKeyword != &quot;&quot;) {</span>
<span class="nc" id="L187">			 System.out.println(&quot;lastSearch enabled&quot;);</span>
<span class="nc" id="L188">			 lastSearch.setDisable(false);</span>
		 }

<span class="nc" id="L191">		 System.out.println(&quot;actionSearch: &quot; + textFieldKeyword.getText());</span>
<span class="nc" id="L192">		 List&lt;Item&gt; result = scraper.scrape(textFieldKeyword.getText());</span>
<span class="nc" id="L193">		 String output = &quot;Total items scrapped = &quot; + size + &quot;.\t&quot; + &quot;Total pages obtained = &quot; + pages + &quot;.\n\n&quot;;</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">		 for (Item item : result) {</span>
<span class="nc" id="L195">			 output += item.getTitle() + &quot;\t&quot; + item.getPortal() + &quot;\t&quot; + item.getPrice() + &quot;\t&quot; + item.getUrl() + &quot;\t&quot; + item.getDate() + &quot;\n&quot;;</span>
<span class="nc" id="L196">		 }</span>
<span class="nc" id="L197">		 textAreaConsole.setText(output);</span>
<span class="nc" id="L198">		 RefineButton.setDisable(false);</span>
<span class="nc" id="L199">		 size = 0;</span>
<span class="nc" id="L200">		 pages = 0;</span>
		 
<span class="nc" id="L202">		 return result;</span>
	 }
	 
	 private void summary(List&lt;Item&gt; result) throws ParseException {
<span class="nc bnc" id="L206" title="All 2 branches missed.">		 if(result.size() &gt; 0) {</span>
<span class="nc" id="L207">			 double sum=0;</span>
<span class="nc" id="L208">			 int count=0;</span>
<span class="nc" id="L209">			 double min= Double.POSITIVE_INFINITY;</span>
<span class="nc" id="L210">			 String urlMin = &quot;&quot;;</span>
<span class="nc" id="L211">			 SimpleDateFormat simpleDateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm&quot;);</span>
<span class="nc" id="L212">			 Date latest = simpleDateFormat.parse(&quot;0000-00-00 00:00&quot;);</span>
<span class="nc" id="L213">			 String urlLatest = &quot;&quot;;</span>

<span class="nc" id="L215">			 labelCount.setText(Integer.toString(result.size()));</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">			 for(Item item : result) {</span>
<span class="nc" id="L217">				 sum += item.getPrice();</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">				 if(item.getPrice()&gt;0.0) {</span>
<span class="nc" id="L219">					 count++;</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">					 if(item.getPrice()&lt;min) {</span>
<span class="nc" id="L221">						 min = item.getPrice();</span>
<span class="nc" id="L222">						 urlMin = item.getUrl();</span>
					 }

				 }
<span class="nc bnc" id="L226" title="All 2 branches missed.">				 if(item.getDate() != &quot;-&quot;) {</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">					 if(simpleDateFormat.parse(item.getDate()).after(latest)) {</span>
<span class="nc" id="L228">						 latest = simpleDateFormat.parse(item.getDate());</span>
<span class="nc" id="L229">						 urlLatest = item.getUrl();</span>
					 }
				 }
<span class="nc" id="L232">			 }</span>

<span class="nc" id="L234">			 labelPrice.setText(String.format(&quot;%f&quot;, (float)sum/count));</span>
<span class="nc" id="L235">			 labelMin.setText(urlMin);</span>
<span class="nc" id="L236">			 labelLatest.setText(urlLatest);</span>

<span class="nc" id="L238">		 }else {</span>
<span class="nc" id="L239">			 labelCount.setText(&quot;0&quot;);</span>
<span class="nc" id="L240">			 labelPrice.setText(&quot;-&quot;);</span>
<span class="nc" id="L241">			 labelMin.setText(&quot;-&quot;);</span>
<span class="nc" id="L242">			 labelLatest.setText(&quot;-&quot;);</span>
		 }

<span class="nc" id="L245">	 }</span>


	 private void fillTable (List&lt;Item&gt; result) {
<span class="nc" id="L249">		 table.getItems().clear();</span>
<span class="nc" id="L250">		 itemTitle.setCellValueFactory(new PropertyValueFactory&lt;TableItem, String&gt;(&quot;title&quot;));</span>
<span class="nc" id="L251">		 itemPrice.setCellValueFactory(new PropertyValueFactory&lt;TableItem, Double&gt;(&quot;price&quot;));</span>
<span class="nc" id="L252">		 itemURL.setCellValueFactory(new PropertyValueFactory&lt;TableItem, String&gt;(&quot;url&quot;));</span>
<span class="nc" id="L253">		 itemDate.setCellValueFactory(new PropertyValueFactory&lt;TableItem, String&gt;(&quot;date&quot;));</span>


		 //List&lt;Item&gt; property = new List&lt;Item&gt;
<span class="nc" id="L257">		 ArrayList&lt;TableItem&gt; tableItem = new ArrayList&lt;TableItem&gt;();</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">		 for(Item item: result) {</span>
			 //tableItem.add(new TableItem(item.getTitle(),item.getPrice(),item.getTitle(),item.getDate()));
			 //System.out.println(item.getTitle() + '\t' + item.getUrl());
<span class="nc" id="L261">			 TableItem temp = new TableItem(item.getTitle(),item.getPrice(),item.getTitle(),item.getDate());</span>
<span class="nc" id="L262">			 temp.setUrl(item.getUrl());</span>
<span class="nc" id="L263">			 tableItem.add(temp);</span>
<span class="nc" id="L264">		 }</span>
<span class="nc" id="L265">		 final ObservableList&lt;TableItem&gt; data = FXCollections.observableArrayList(tableItem);</span>
		 /*for(TableItem item: data) {
        	System.out.println(item.getTitle() + '\t' + item.getURL());
        }*/

		 //table.setItems(data);
		 //table.getColumns().setAll();
<span class="nc" id="L272">		 table.getItems().addAll(data);</span>
		 //table.getColumns().addAll(itemTitle, itemPrice, itemURL,itemDate);

<span class="nc" id="L275">	 }</span>
	 
	 public Alert dialogAbout() {
<span class="nc" id="L278">		 Alert dg = new Alert(Alert.AlertType.INFORMATION);</span>
<span class="nc" id="L279">		 dg.setTitle(&quot;About the team&quot;);</span>
<span class="nc" id="L280">		 dg.setHeaderText(&quot;COMP3111 Project Team No. 34&quot;);</span>
<span class="nc" id="L281">		 dg.setContentText(&quot;Developers Info: &quot;</span>
				 + &quot;\n CHAN, Siu Him\t ITSC: shchanam\t GitHub: https://github.com/zach1king&quot;
				 + &quot;\n CHANG, Hiu Tung\t ITSC: htchang\t Github: https://github.com/htchang1&quot;
				 + &quot;\n LEE, Yuen Nam\t ITSC: ynleeaa\t Github: https://github.com/heidileeyn&quot;);
<span class="nc" id="L285">		 return dg;</span>
	 }
	 
	 public void last() {
<span class="nc" id="L289">		 lastSearch.setDisable(true);</span>
		 
<span class="nc bnc" id="L291" title="All 2 branches missed.">		 if (lastKeyword != &quot;&quot;) {</span>
<span class="nc" id="L292">			 textFieldKeyword.setText(lastKeyword);</span>
		 }
<span class="nc" id="L294">	 }</span>
	 
	 public void quit() {
<span class="nc" id="L297">		 scraper.close();</span>
<span class="nc" id="L298">		 System.exit(0);</span>
<span class="nc" id="L299">	 }</span>

	 public void close() {
<span class="fc" id="L302">		 lastKeyword = &quot;&quot;;</span>
<span class="fc" id="L303">		 latestKeyword = &quot;&quot;;</span>
<span class="nc" id="L304">		 lastSearch.setDisable(true);</span>
<span class="nc" id="L305">		 textFieldKeyword.setText(&quot;&quot;);</span>
<span class="nc" id="L306">		 textAreaConsole.setText(&quot;&quot;);</span>
<span class="nc" id="L307">		 labelCount.setText(&quot;&lt;total&gt;&quot;);</span>
<span class="nc" id="L308">		 labelPrice.setText(&quot;&lt;AvgPrice&gt;&quot;);</span>
<span class="nc" id="L309">		 labelMin.setText(&quot;&lt;Lowest&gt;&quot;);</span>
<span class="nc" id="L310">		 labelLatest.setText(&quot;&lt;Latest&gt;&quot;);</span>
<span class="nc" id="L311">		 table.getItems().clear();</span>
<span class="nc" id="L312">	 }</span>
	 
	 public boolean getStatus_isDisabledLastSearch() {
<span class="nc" id="L315">		 return lastSearch.isDisable();</span>
	 }
	 
<span class="nc" id="L318">	 public String getTextFieldKeyword() { return textFieldKeyword.getText(); }</span>
	 
<span class="nc" id="L320">	 public String getTextAreaConsole() { return textAreaConsole.getText(); }</span>
	 
<span class="nc" id="L322">	 public String getLabelCount() { return labelCount.getText(); }</span>
	 
<span class="nc" id="L324">	 public String getLabelPrice() { return labelPrice.getText(); }</span>
	 
<span class="nc" id="L326">	 public String getLabelMin() { return labelMin.getText(); }</span>
	 
<span class="nc" id="L328">	 public String getLabelLatest() { return labelLatest.getText(); }</span>
	 
<span class="nc" id="L330">	 public boolean isTableClean() { return Bindings.isEmpty(table.getItems()).get(); }</span>

}




</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>